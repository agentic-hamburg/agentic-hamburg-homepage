---
export interface Props {
  title?: string;
  description?: string;
}

const {
  title = "Subscribe to onTree Updates",
  description = "Get insights about organizational growth, team dynamics, and the future of work delivered to your inbox.",
} = Astro.props;
---

<div
  class="newsletter-form my-8 rounded-lg border border-gray-200 bg-gray-50 p-6"
>
  <h3 class="mb-2 text-xl font-bold">{title}</h3>
  <p class="mb-4 text-gray-600">{description}</p>

  <form
    id="newsletter-form"
    action="/api/subscribe"
    method="post"
    class="flex flex-col gap-3 sm:flex-row"
  >
    <input
      type="email"
      name="email"
      placeholder="Your email address"
      required
      class="flex-1 rounded-md border border-gray-300 bg-white px-4 py-2 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
      aria-label="Email address"
    />
    <button
      type="submit"
      class="relative rounded-md bg-blue-600 px-6 py-2 font-medium text-white transition-opacity hover:bg-blue-700"
      aria-label="Subscribe to newsletter"
    >
      <span class="button-text">Subscribe</span>
      <span class="button-loading hidden">
        <svg
          class="h-5 w-5 animate-spin text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      </span>
    </button>
  </form>

  <p class="mt-3 text-xs text-gray-500">No spam, unsubscribe at any time.</p>

  <div
    id="form-message"
    class="mt-3 hidden text-sm"
    role="alert"
    aria-live="polite"
  >
  </div>
</div>

<style>
  .button-loading {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
  }

  .form-loading .button-text {
    visibility: hidden;
  }

  .form-loading .button-loading {
    display: block !important;
  }

  .message-success {
    color: rgb(34, 197, 94);
  }

  .message-error {
    color: rgb(239, 68, 68);
  }
</style>

<script>
  import {
    trackNewsletterSubscribe,
    trackNewsletterSuccess,
    trackNewsletterError,
  } from "@/utils/analytics";

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("newsletter-form") as HTMLFormElement;
    const messageDiv = document.getElementById(
      "form-message"
    ) as HTMLDivElement;

    if (!form || !messageDiv) {
      return;
    }

    const submitButton = form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement;

    form.addEventListener("submit", async e => {
      e.preventDefault();
      e.stopPropagation();

      // Clear previous messages
      messageDiv.classList.add("hidden");
      messageDiv.classList.remove("message-success", "message-error");

      // Show loading state
      submitButton.classList.add("form-loading");
      submitButton.disabled = true;

      // Determine source based on current page
      const isOnBlogPost =
        window.location.pathname.includes("/blog/") &&
        !window.location.pathname.endsWith("/blog/");
      const source = isOnBlogPost ? "blog_post" : "blog_list";

      // Track subscribe attempt
      trackNewsletterSubscribe(source);

      try {
        const formData = new FormData(form);
        const email = formData.get("email");

        // Add timeout to handle slow responses
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        const response = await fetch("/api/subscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            firstName: "Blog Reader",
            email: email,
          }),
          signal: controller.signal,
        });

        clearTimeout(timeoutId);
        const result = await response.json();

        if (response.ok) {
          // Success
          messageDiv.textContent = result.message || "Successfully subscribed!";
          messageDiv.classList.add("message-success");
          messageDiv.classList.remove("hidden");

          // Track success
          trackNewsletterSuccess(source);

          // Clear form
          form.reset();
        } else {
          // Error
          const errorMessage =
            result.message || "Something went wrong. Please try again.";
          messageDiv.textContent = errorMessage;
          messageDiv.classList.add("message-error");
          messageDiv.classList.remove("hidden");

          // Track error
          trackNewsletterError(source, errorMessage);
        }
      } catch (error) {
        // Network error or timeout
        let errorMessage: string;
        if (error instanceof Error && error.name === "AbortError") {
          errorMessage = "Request timed out. Please try again later.";
        } else {
          errorMessage =
            "Network error. Please check your connection and try again.";
        }
        messageDiv.textContent = errorMessage;
        messageDiv.classList.add("message-error");
        messageDiv.classList.remove("hidden");

        // Track error
        trackNewsletterError(source, errorMessage);
      } finally {
        // Reset loading state
        submitButton.classList.remove("form-loading");
        submitButton.disabled = false;
      }
    });
  });

  // Also handle Astro's view transitions
  document.addEventListener("astro:page-load", () => {
    const form = document.getElementById("newsletter-form") as HTMLFormElement;
    const messageDiv = document.getElementById(
      "form-message"
    ) as HTMLDivElement;

    if (!form || !messageDiv) return;

    const submitButton = form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement;

    // Re-attach event listener after view transitions
    form.removeEventListener("submit", handleSubmit);
    form.addEventListener("submit", handleSubmit);

    async function handleSubmit(e: Event) {
      e.preventDefault();
      e.stopPropagation();

      // Clear previous messages
      messageDiv.classList.add("hidden");
      messageDiv.classList.remove("message-success", "message-error");

      // Show loading state
      submitButton.classList.add("form-loading");
      submitButton.disabled = true;

      // Determine source based on current page
      const isOnBlogPost =
        window.location.pathname.includes("/blog/") &&
        !window.location.pathname.endsWith("/blog/");
      const source = isOnBlogPost ? "blog_post" : "blog_list";

      // Track subscribe attempt
      trackNewsletterSubscribe(source);

      try {
        const formData = new FormData(form);
        const email = formData.get("email");

        // Add timeout to handle slow responses
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        const response = await fetch("/api/subscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            firstName: "Blog Reader",
            email: email,
          }),
          signal: controller.signal,
        });

        clearTimeout(timeoutId);
        const result = await response.json();

        if (response.ok) {
          // Success
          messageDiv.textContent = result.message || "Successfully subscribed!";
          messageDiv.classList.add("message-success");
          messageDiv.classList.remove("hidden");

          // Clear form
          form.reset();
        } else {
          // Error
          messageDiv.textContent =
            result.error || "Something went wrong. Please try again.";
          messageDiv.classList.add("message-error");
          messageDiv.classList.remove("hidden");
        }
      } catch (error) {
        // Network error or timeout
        let errorMessage: string;
        if (error instanceof Error && error.name === "AbortError") {
          errorMessage = "Request timed out. Please try again later.";
        } else {
          errorMessage =
            "Network error. Please check your connection and try again.";
        }
        messageDiv.textContent = errorMessage;
        messageDiv.classList.add("message-error");
        messageDiv.classList.remove("hidden");

        // Track error
        trackNewsletterError(source, errorMessage);
      } finally {
        // Reset loading state
        submitButton.classList.remove("form-loading");
        submitButton.disabled = false;
      }
    }
  });
</script>
