---
export interface Props {
  title?: string;
  description?: string;
}

const {
  title = "Join the Community",
  description = "Get notified about new events from us. No spam, unsubscribe at any time. One mail per month.",
} = Astro.props;
---

<div
  class="newsletter-form border border-black bg-[var(--color-shell-rose)] p-8 sm:p-10"
>
  <h2 class="mb-6 text-3xl font-bold">{title}</h2>
  <p class="mb-4 text-gray-600">{description}</p>

  <form
    id="newsletter-form"
    action="/api/subscribe"
    method="post"
    class="flex flex-col gap-3"
  >
    <input
      type="email"
      name="email"
      placeholder="Enter your email address"
      required
      class="flex-1 rounded-md border border-gray-400 bg-[var(--color-shell-gray-light)] px-4 py-2 text-gray-800 placeholder-gray-500 focus:border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-700"
      aria-label="Email address"
    />

    <button
      type="submit"
      class="newsletter-button newsletter-button--medium"
      aria-label="Subscribe to newsletter"
    >
      <span class="button-text">Keep me informed</span>
      <span class="button-loading hidden">
        <svg
          class="h-5 w-5 animate-spin text-black"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      </span>
    </button>
  </form>

  <div
    id="form-message"
    class="mt-3 hidden text-sm"
    role="alert"
    aria-live="polite"
  >
  </div>
</div>

<style>
  .newsletter-button {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    cursor: pointer;
    border: 0;
    background: transparent;
    color: #111;
    font-family:
      "Quicksand",
      system-ui,
      -apple-system,
      sans-serif;
    font-weight: 600;
    letter-spacing: 0.01em;
    text-transform: none;
    isolation: isolate;
    transition: color 0.2s ease;
    border-radius: 0;
  }

  .newsletter-button--medium {
    padding: 0.75rem 2.4rem;
    font-size: 0.95rem;
    min-height: 42px;
  }

  .newsletter-button > span {
    position: relative;
    z-index: 1;
  }

  .newsletter-button::before,
  .newsletter-button::after {
    content: "";
    position: absolute;
    inset: 0;
    border: 1px solid #0f0f0f;
    pointer-events: none;
    border-radius: 0;
  }

  .newsletter-button::before {
    inset: -4px;
    background: transparent;
  }

  .newsletter-button::after {
    background: var(--color-shell-soft-light);
  }

  .newsletter-button:hover {
    color: #000;
  }

  .newsletter-button:hover::after {
    background: var(--color-shell-soft);
  }

  .button-loading {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
  }

  .form-loading .button-text {
    visibility: hidden;
  }

  .form-loading .button-loading {
    display: block !important;
  }

  .message-success {
    color: rgb(34, 197, 94);
  }

  .message-error {
    color: rgb(239, 68, 68);
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("newsletter-form") as HTMLFormElement;
    const messageDiv = document.getElementById(
      "form-message"
    ) as HTMLDivElement;

    if (!form || !messageDiv) {
      return;
    }

    const submitButton = form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement;

    form.addEventListener("submit", async e => {
      e.preventDefault();
      e.stopPropagation();

      // Clear previous messages
      messageDiv.classList.add("hidden");
      messageDiv.classList.remove("message-success", "message-error");

      // Show loading state
      submitButton.classList.add("form-loading");
      submitButton.disabled = true;

      try {
        const formData = new FormData(form);
        const response = await fetch("/api/subscribe", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          // Success
          messageDiv.textContent = result.message || "Successfully subscribed!";
          messageDiv.classList.add("message-success");
          messageDiv.classList.remove("hidden");

          // Clear form
          form.reset();
        } else {
          // Error
          messageDiv.textContent =
            result.error || "Something went wrong. Please try again.";
          messageDiv.classList.add("message-error");
          messageDiv.classList.remove("hidden");
        }
      } catch {
        // Network error
        messageDiv.textContent =
          "Network error. Please check your connection and try again.";
        messageDiv.classList.add("message-error");
        messageDiv.classList.remove("hidden");
      } finally {
        // Reset loading state
        submitButton.classList.remove("form-loading");
        submitButton.disabled = false;
      }
    });
  });

  // Also handle Astro's view transitions
  document.addEventListener("astro:page-load", () => {
    const form = document.getElementById("newsletter-form") as HTMLFormElement;
    const messageDiv = document.getElementById(
      "form-message"
    ) as HTMLDivElement;

    if (!form || !messageDiv) return;

    const submitButton = form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement;

    // Re-attach event listener after view transitions
    form.removeEventListener("submit", handleSubmit);
    form.addEventListener("submit", handleSubmit);

    async function handleSubmit(e: Event) {
      e.preventDefault();
      e.stopPropagation();

      // Clear previous messages
      messageDiv.classList.add("hidden");
      messageDiv.classList.remove("message-success", "message-error");

      // Show loading state
      submitButton.classList.add("form-loading");
      submitButton.disabled = true;

      try {
        const formData = new FormData(form);
        const response = await fetch("/api/subscribe", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          // Success
          messageDiv.textContent = result.message || "Successfully subscribed!";
          messageDiv.classList.add("message-success");
          messageDiv.classList.remove("hidden");

          // Clear form
          form.reset();
        } else {
          // Error
          messageDiv.textContent =
            result.error || "Something went wrong. Please try again.";
          messageDiv.classList.add("message-error");
          messageDiv.classList.remove("hidden");
        }
      } catch {
        // Network error
        messageDiv.textContent =
          "Network error. Please check your connection and try again.";
        messageDiv.classList.add("message-error");
        messageDiv.classList.remove("hidden");
      } finally {
        // Reset loading state
        submitButton.classList.remove("form-loading");
        submitButton.disabled = false;
      }
    }
  });
</script>
